---
- name: Grundkonfiguration Worker
  hosts: kubeworker
  become: true
  become_method: sudo
  tasks:
    - name: Hostname setzen
      command: hostnamectl set-hostname "kubeworker.ansible.local"

    - name: /etc/hosts Eintrag
      lineinfile:
        path: /etc/hosts
        line: 192.168.26.165  kubeworker.ansible.local kubeworker
        state: present

    - name: Swap deaktivieren
      command: swapoff -a

    - name: Swap Eintrag aus /etc/fstab entfernen
      lineinfile:
        dest: /etc/fstab
        regexp: swap
        state: absent

    - name: Kernel Module laden
      blockinfile:
        path: /etc/modules-load.d/containerd.conf
        block: |
          overlay
          br_netfilter

    - name: overlay prüfen
      command: modprobe overlay

    - name: br_netfilter prüfen
      command: modprobe br_netfilter

    - name: Kubernetes Kernel Parameter setzen
      blockinfile:
        path: /etc/sysctl.d/kubernetes.conf
        block: |
          net.bridge.bridge-nf-call-ip6tables = 1
          net.bridge.bridge-nf-call-iptables = 1
          net.ipv4.ip_forward = 1

    - name: Änderungen neuladen
      command: sysctl --system

